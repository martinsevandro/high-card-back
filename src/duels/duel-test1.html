<!doctype html>
<html lang="pt-br">
   <head>
      <meta charset="UTF-8" />
      <title>Duel Test 1</title>
      <style>
         body {
            font-family: Arial, sans-serif;
         }
         #deck button.selected {
            background-color: #4caf50;
            color: white;
         }
      </style>
   </head>
   <body>
      <h2>Usuário: yu1</h2>

      <button id="joinQueue">Entrar na fila</button>
      <button id="leaveQueue">Sair da fila</button>

      <h3>Status:</h3>
      <div id="status">Desconectado</div>

      <h3>Suas cartas (3 selecionadas):</h3>
      <div id="deck"></div>

      <h3>Sua escolha:</h3>
      <div id="selectedCard">Nenhuma</div>

      <h3>Histórico do Oponente:</h3>
      <div id="opponentCardDiv">Nenhuma</div>

      <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
      <script>
         const username = 'yu1';
         const userId = '6877ec47f06d00e63c7561ff';
         const accessToken =
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiI2ODc3ZWM0N2YwNmQwMGU2M2M3NTYxZmYiLCJ1c2VybmFtZSI6Inl1MSIsImlhdCI6MTc1MzMxMTA1NiwiZXhwIjoxNzUzMzk3NDU2fQ.uUULp24ILV5G3AdVq6dir7hCMuCyNpb6AvFwBkqzxNI';

         const socket = io('http://localhost:3000', {
            auth: {
               token: accessToken,
            },
         });

         const statusDiv = document.getElementById('status');
         const deckDiv = document.getElementById('deck');
         const selectedCardDiv = document.getElementById('selectedCard');

         let selectedCard = null;
         let currentDeck = [];
         let inMatch = false;

         socket.on('connect', () => {
            statusDiv.textContent = 'Conectado';
            console.log('meu socket.id:', socket.id);
         });

         socket.on('waiting_for_opponent', () => {
            if (!inMatch) {
               statusDiv.textContent = 'Aguardando oponente...';
            }
         });

         socket.on('queue_left', () => {
            if (!inMatch) {
               statusDiv.textContent = 'Saiu da fila recentemente.';
            }
         });

         socket.on('duel_start', (data) => {
            inMatch = true;
            console.log('duel_start recebido:', data);
            statusDiv.textContent = `Duelo contra ${data.opponent}, sala: ${data.roomId}`;
            if (Array.isArray(data.deck)) {
               currentDeck = data.deck;
               renderDeck(currentDeck);
            } else {
               console.error('deck inválido recebido:', data.deck);
            }
         });

         socket.on('opponent_disconnected', () => {
            inMatch = false;
            statusDiv.textContent = 'O oponente saiu da partida.';
            deckDiv.innerHTML = '';
            selectedCardDiv.textContent = 'Nenhuma';
         });

         socket.on('roundSummary', (data) => {
            const { round, card1KDA, card2KDA, result, scores } = data;

            statusDiv.textContent =
               `Rodada ${round}: ${result} | ` +
               `KDA P1: ${card1KDA} vs KDA P2: ${card2KDA} | ` +
               `Placar: ${JSON.stringify(scores)}`;
         });

         socket.on('roundResult', (data) => {
            const { yourCard, opponentCard, result, scores } = data;

            if (opponentCard && opponentCard.championName) {
               const oponenteDiv = document.getElementById('opponentCardDiv');
               oponenteDiv.textContent = `Oponente usou: ${opponentCard.championName} (KDA: ${opponentCard.kda})`;
            }

            deckDiv.innerHTML = '';
            selectedCardDiv.textContent = 'Nenhuma';
         });

         socket.on('nextRound', (data) => {
            console.log('Deck recebido no nextRound:', data.deck);
            // statusDiv.textContent = `Rodada ${data.round} iniciada`;
            currentDeck = data.deck;
            selectedCard = null;
            selectedCardDiv.textContent = 'Nenhuma';
            renderDeck(currentDeck);
         });

         socket.on('duelEnded', (data) => {
            inMatch = false;
            console.log('Evento duelEnded recebido no frontend:', data);
            let resultadoFinal;

            if (data.winnerSocketId === socket.id) {
               resultadoFinal = 'Você venceu o duelo!';
            } else if (data.winnerSocketId === null) {
               resultadoFinal = 'O duelo terminou empatado!';
            } else {
               resultadoFinal = 'Você perdeu o duelo!';
            }

            statusDiv.textContent = `${resultadoFinal} | Placar final: ${JSON.stringify(data.scores)}`;
            deckDiv.innerHTML = '';
            selectedCardDiv.textContent = 'Nenhuma';
         });

         document.getElementById('joinQueue').onclick = () => {
            socket.emit('join_duel_queue', {
               userId: userId,
               username: username,
            });
         };

         document.getElementById('leaveQueue').onclick = () => {
            socket.emit('leave_duel_queue');
         };

         function renderDeck(deck) {
            console.log(
               'Renderizando deck com cartas:',
               deck.map((c) => c._id),
            );
            deckDiv.innerHTML = '';
            selectedCard = null;
            selectedCardDiv.textContent = 'Nenhuma';

            deck.forEach((card, index) => {
               const btn = document.createElement('button');
               btn.textContent = `Carta ${index + 1} - ${card.championName} - KDA: ${card.kda}`;
               btn.onclick = () => {
                  selectedCard = card;
                  selectedCardDiv.textContent = `Selecionada: ${card.championName}`;

                  [...deckDiv.children].forEach((b) =>
                     b.classList.remove('selected'),
                  );
                  btn.classList.add('selected');

                  console.log('Carta selecionada:', card);
                  socket.emit('playCard', { selectedCard: card });

                  [...deckDiv.children].forEach((b) => (b.disabled = true));
               };
               deckDiv.appendChild(btn);
            });
         }
      </script>
   </body>
</html>
